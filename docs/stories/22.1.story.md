# Story 22.1: Game Type Data Model and Conference Championship Import

**Epic:** EPIC-022 - Conference Championship Game Support
**Story:** 22.1
**Estimated Effort:** 4-6 hours

---

## User Story

As a **ranking system administrator**,
I want **conference championship games imported from CFBD API with game type classification**,
So that **conference championship games appear on team schedules and can be distinguished from regular season games**.

---

## Story Context

### Existing System Integration

- **Integrates with:**
  - `models.py` - SQLAlchemy ORM models (Game model)
  - `cfbd_client.py` - CFBD API integration client
  - `import_real_data.py` - Main data import script
  - `scripts/weekly_update.py` - Weekly game update script
  - Alembic migration system
- **Technology:** Python 3.x, SQLAlchemy, SQLite/PostgreSQL, CFBD API
- **Follows pattern:** Additive schema changes with nullable columns for backward compatibility (similar to EPIC-021 quarter scores)
- **Touch points:**
  - `Game` model (models.py:60-144)
  - CFBD API client `get_games()` method (cfbd_client.py:390-400)
  - Import script game creation logic (import_real_data.py)

### Current State

**Current Game Model Fields:**
- `week` (Integer) - Week number (0-15 supported, postseason = 14-15)
- `season` (Integer) - Season year
- `home_team_id`, `away_team_id` (Integer) - Team references
- `home_score`, `away_score` (Integer) - Final scores
- No `game_type` field to distinguish regular season vs postseason games

**Current CFBD Integration:**
- Fetches regular season games only (no `season_type` parameter specified)
- Does not import conference championship games
- Week range: 1-15 (weeks 14-15 available but unused)

**Desired State:**
- Add `game_type` VARCHAR(50) nullable field to distinguish game types
- CFBD API client supports `season_type='postseason'` parameter
- Import scripts fetch and import conference championship games
- Conference championships have `game_type='conference_championship'`
- Regular season games have `game_type=NULL` (backward compatible default)

---

## Acceptance Criteria

### Functional Requirements

1. **Game model includes game_type field**
   - New VARCHAR(50) field (nullable): `game_type`
   - Field defaults to NULL for backward compatibility
   - Valid values: NULL (regular season), 'conference_championship', 'bowl' (future), 'playoff' (future)

2. **CFBD API client supports postseason game fetching**
   - Update `get_games()` method to accept optional `season_type` parameter
   - `season_type='regular'` fetches regular season games (default behavior)
   - `season_type='postseason'` fetches postseason games (championships, bowls, playoffs)
   - Handles missing postseason data gracefully (returns empty list)
   - Respects API rate limits

3. **Import scripts import conference championship games**
   - `import_real_data.py` fetches postseason games after regular season import
   - Filters postseason games to import only conference championships
   - Sets `game_type='conference_championship'` for conference championship games
   - Excludes bowl games and playoff games (to be handled in EPIC-023)
   - Conference championships imported with correct week numbers (typically 14-15)

4. **Conference championship identification logic**
   - Uses CFBD API metadata to identify conference championship games
   - Typical identifiers: game notes contain "Championship", specific week range (14), neutral site flag
   - Validates expected count: ~10 conference championships per season (one per FBS conference)
   - Logs games identified as conference championships for verification

### Integration Requirements

5. **Existing regular season games unchanged**
   - Regular season games have `game_type=NULL` (no migration needed for existing records)
   - Existing queries selecting games work unchanged
   - API endpoints returning game data handle NULL game_type gracefully

6. **Database migration runs successfully**
   - Alembic migration adds `game_type` column to games table
   - Migration runs without errors on dev database
   - Migration provides downgrade script to remove column if needed
   - Existing game records default to NULL for game_type

7. **CFBD API integration maintains existing functionality**
   - Regular season game import still works (unchanged behavior)
   - API rate limiting and error handling unchanged
   - Logging shows conference championship import status

### Quality Requirements

8. **Unit tests cover new functionality**
   - Test Game model with game_type values (NULL, 'conference_championship')
   - Test CFBD API client with season_type parameter
   - Test conference championship identification logic

9. **Integration tests verify end-to-end flow**
   - Test importing conference championship games from CFBD API
   - Test game_type field populated correctly
   - Test filtering excludes bowl/playoff games
   - Test no duplicate games created (conference championships vs regular season)

10. **Database performance maintained**
    - Query performance for games table remains acceptable
    - Consider index on game_type if filtering queries are common
    - Migration completes in reasonable time (< 1 minute)

---

## Technical Implementation

### Changes Required

#### File 1: `models.py` - Add game_type Field

**Location:** models.py:60-144 (Game model)

**Changes:**
```python
class Game(Base):
    """Game model"""
    __tablename__ = "games"

    id = Column(Integer, primary_key=True, index=True)

    # Teams
    home_team_id = Column(Integer, ForeignKey("teams.id"), nullable=False)
    away_team_id = Column(Integer, ForeignKey("teams.id"), nullable=False)

    # Scores
    home_score = Column(Integer, nullable=False)
    away_score = Column(Integer, nullable=False)

    # ... existing quarter score fields ...

    # Game info
    week = Column(Integer, nullable=False)
    season = Column(Integer, nullable=False)
    is_neutral_site = Column(Boolean, default=False)
    game_date = Column(DateTime, nullable=True)

    # NEW: Game type classification
    # NULL = regular season (default for backward compatibility)
    # 'conference_championship' = conference championship game
    # 'bowl' = bowl game (EPIC-023)
    # 'playoff' = playoff game (EPIC-023)
    game_type = Column(String(50), nullable=True, index=True)

    # ... rest of existing fields ...
```

**Index Consideration:**
- Add index on `game_type` if filtering queries become common
- Start without index, add in future optimization if needed

#### File 2: Create Alembic Migration

**Command:**
```bash
alembic revision -m "Add game_type to games table"
```

**Migration File:** `alembic/versions/XXXX_add_game_type.py`

**Upgrade:**
```python
def upgrade():
    op.add_column('games', sa.Column('game_type', sa.String(50), nullable=True))
    # Optional: Add index if filtering is common
    # op.create_index('ix_games_game_type', 'games', ['game_type'])
```

**Downgrade:**
```python
def downgrade():
    # Drop index if created
    # op.drop_index('ix_games_game_type', 'games')
    op.drop_column('games', 'game_type')
```

#### File 3: `cfbd_client.py` - Add season_type Parameter

**Location:** cfbd_client.py:390-420 (get_games method)

**Changes:**
```python
def get_games(self, year: int, week: int = None, team: str = None,
              season_type: str = 'regular') -> List[dict]:
    """
    Fetch games from CFBD API

    Args:
        year: Season year
        week: Optional week number
        team: Optional team name filter
        season_type: 'regular' or 'postseason' (default: 'regular')

    Returns:
        List of game dictionaries
    """
    params = {
        'year': year,
        'seasonType': season_type  # NEW: Add season_type parameter
    }

    if week is not None:
        params['week'] = week

    if team is not None:
        params['team'] = team

    try:
        response = self.session.get(
            f"{self.base_url}/games",
            params=params,
            timeout=10
        )
        response.raise_for_status()

        games = response.json()
        logger.info(f"Fetched {len(games)} {season_type} games for {year}")

        return games

    except requests.exceptions.RequestException as e:
        logger.error(f"Failed to fetch {season_type} games for {year}: {e}")
        return []
```

#### File 4: `import_real_data.py` - Import Conference Championships

**New Function:**
```python
def import_conference_championships(db: Session, cfbd: CFBDClient, year: int):
    """
    Import conference championship games for a season

    Args:
        db: Database session
        cfbd: CFBD API client
        year: Season year

    Returns:
        Number of conference championships imported
    """
    print(f"\nImporting conference championship games for {year}...")

    # Fetch postseason games from CFBD
    postseason_games = cfbd.get_games(year, season_type='postseason')

    if not postseason_games:
        print("✗ No postseason games found")
        return 0

    # Filter to conference championships only (exclude bowls/playoffs)
    # Conference championships typically:
    # - Week 14 or 15
    # - Game notes contain "Championship" or similar
    # - Before bowl games (which are typically week 15+)

    conf_championships = []
    for game in postseason_games:
        # Check if this is a conference championship
        # CFBD may provide explicit flags or we can use heuristics
        notes = game.get('notes', '').lower()
        week = game.get('week', 0)

        # Heuristic: Conference championships are week 14-15 and have "championship" in notes
        # Exclude CFP playoff games and bowl games
        if week in [14, 15] and 'championship' in notes:
            # Additional check: exclude CFP playoff (contains "playoff" or "semifinal")
            if 'playoff' not in notes and 'semifinal' not in notes and 'bowl' not in notes:
                conf_championships.append(game)

    print(f"Found {len(conf_championships)} conference championship games")

    # Import each conference championship
    imported_count = 0
    for game_data in conf_championships:
        try:
            # Check if game already exists (prevent duplicates)
            existing_game = db.query(Game).filter(
                Game.home_team_id == get_team_id(db, game_data['home_team']),
                Game.away_team_id == get_team_id(db, game_data['away_team']),
                Game.season == year,
                Game.week == game_data['week']
            ).first()

            if existing_game:
                print(f"  ⚠ Game already exists: {game_data['home_team']} vs {game_data['away_team']}")
                continue

            # Create game with game_type='conference_championship'
            game = create_game_from_api_data(db, game_data, game_type='conference_championship')
            db.add(game)
            imported_count += 1

            print(f"  ✓ Imported: {game_data['home_team']} vs {game_data['away_team']} (Week {game_data['week']})")

        except Exception as e:
            print(f"  ✗ Error importing game: {e}")
            continue

    db.commit()

    print(f"✓ Imported {imported_count} conference championship games")
    return imported_count
```

**Modify Main Import Flow:**
```python
def main():
    # ... existing regular season import ...

    # Import teams
    teams_by_name = import_teams(cfbd, db, year)

    # Import regular season games (existing code)
    for week in range(1, 16):
        import_games_for_week(db, cfbd, year, week)

    # NEW: Import conference championship games
    import_conference_championships(db, cfbd, year)

    # ... rest of existing code ...
```

### Testing Checklist

**Unit Tests (`tests/unit/test_models.py`):**
- [ ] Test Game model with game_type='conference_championship'
- [ ] Test Game model with game_type=NULL (backward compatibility)
- [ ] Test Game model query filtering by game_type

**Unit Tests (`tests/unit/test_cfbd_client.py`):**
- [ ] Test get_games() with season_type='regular' (default)
- [ ] Test get_games() with season_type='postseason'
- [ ] Test get_games() handles empty postseason response

**Integration Tests (`tests/integration/test_import.py`):**
- [ ] Test importing conference championships from CFBD
- [ ] Test conference championship count is reasonable (8-12 games)
- [ ] Test no duplicate games created (regular vs championship)
- [ ] Test game_type field populated correctly

**Database Tests:**
- [ ] Run migration on test database
- [ ] Verify game_type column added successfully
- [ ] Verify existing data unchanged (NULLs populated)
- [ ] Test downgrade migration removes column cleanly

---

## Technical Notes

### Integration Approach
- **Additive schema change**: New nullable column doesn't affect existing queries
- **Separate import step**: Conference championships imported after regular season (prevents conflicts)
- **Filtering logic**: Use CFBD game metadata to identify conference championships vs bowls/playoffs

### CFBD API Reference
- **Endpoint**: `GET /games`
- **Parameters**: `year` (required), `seasonType` ('regular' or 'postseason'), `week` (optional)
- **Response**: List of game objects with team names, scores, week, notes
- **Documentation**: https://api.collegefootballdata.com/api/docs/?url=/api-docs.json#/games/getGames

### Conference Championship Identification Logic

**Primary Identifiers:**
1. **Week number**: Conference championships typically week 14-15
2. **Game notes**: Contain "Championship" (e.g., "SEC Championship", "Big Ten Championship")
3. **Neutral site**: Often played at neutral sites

**Exclusion Criteria:**
- Exclude if notes contain "bowl", "playoff", "semifinal" (those are EPIC-023)
- Expected count: 10 FBS conferences = ~10 championship games

**FBS Conferences (2024):**
- Power 5: SEC, Big Ten, ACC, Big 12, Pac-12 (transitioning)
- Group of 5: American, Mountain West, Conference USA, MAC, Sun Belt

### Key Constraints
- **Backward compatibility**: Existing games with NULL game_type must work
- **No duplicates**: Ensure conference championships not imported as regular season games
- **API rate limits**: CFBD API has limits - one extra call per season for postseason games
- **Data availability**: CFBD may not have postseason data for all historical seasons

### Rollback Plan
If issues arise:
1. Run Alembic downgrade: `alembic downgrade -1`
2. Delete conference championship games: `DELETE FROM games WHERE game_type = 'conference_championship'`
3. Revert import script changes
4. System returns to previous state (regular season only)

---

## Definition of Done

- [ ] **Functional requirements met**
  - [ ] Game model has game_type field
  - [ ] CFBD client supports season_type parameter
  - [ ] Import scripts import conference championships
  - [ ] Conference championship identification logic works correctly

- [ ] **Integration requirements verified**
  - [ ] Existing regular season games unchanged
  - [ ] Database migration runs successfully
  - [ ] CFBD API integration maintains functionality
  - [ ] ~10 conference championship games imported per season

- [ ] **Existing functionality regression tested**
  - [ ] Regular season game queries work with new column
  - [ ] API endpoints return game data correctly
  - [ ] Import scripts complete without errors
  - [ ] No duplicate games created

- [ ] **Code follows existing patterns and standards**
  - [ ] SQLAlchemy model follows existing pattern
  - [ ] Migration follows project migration pattern
  - [ ] CFBD client method follows existing style

- [ ] **Tests pass (existing and new)**
  - [ ] All unit tests pass
  - [ ] Integration tests pass
  - [ ] Migration tested on dev database

- [ ] **Documentation updated**
  - [ ] models.py docstrings updated
  - [ ] CFBD client method documented
  - [ ] Import function documented
  - [ ] Migration notes included

---

## Risk and Compatibility Check

### Risk Assessment

**Primary Risk:** Conference championship identification logic incorrectly categorizes bowl games as championships

**Mitigation:**
- Use conservative filtering criteria (week 14-15 + "championship" in notes)
- Exclude games with "bowl", "playoff", "semifinal" in notes
- Log all imported conference championship games for manual verification
- Expected count validation: warn if count != 8-12 games

**Secondary Risk:** Duplicate games created (same game imported as both regular season and championship)

**Mitigation:**
- Check for existing games before importing conference championships
- Use unique constraint: home_team + away_team + season + week
- Import conference championships AFTER regular season (detect duplicates)

**Rollback:**
- Alembic downgrade removes column cleanly
- `DELETE FROM games WHERE game_type = 'conference_championship'` removes imported games
- Code gracefully handles missing column (column is nullable)

### Compatibility Verification

- [x] **No breaking changes to existing APIs** - New column is additive and nullable
- [x] **Database changes are additive only** - No existing columns modified
- [x] **No UI changes in this story** - Backend-only changes (UI is Story 22.2)
- [x] **Performance impact minimal** - One VARCHAR(50) nullable column adds negligible overhead

---

## Related Files

- `models.py` - Game model definition
- `cfbd_client.py` - CFBD API integration
- `import_real_data.py` - Main import script
- `scripts/weekly_update.py` - Weekly update script
- `alembic/versions/` - Database migrations
- `tests/unit/test_models.py` - Model tests
- `tests/unit/test_cfbd_client.py` - API client tests
- `tests/integration/test_import.py` - Import tests

---

## Next Story

**Story 22.2**: Frontend Display of Conference Championship Games - Update frontend to display conference championship badge on team schedules
