# Story 28.5: Reorganize Migration and Diagnostic Scripts

**Status:** ðŸ“‹ To Do
**Epic:** EPIC-028 Comprehensive Codebase Cleanup
**Priority:** Medium
**Risk Level:** ðŸŸ¡ Medium Risk
**Estimated Effort:** 4-5 hours

---

## Story

As a **developer or operator managing the Stat-urday Synthesis database and troubleshooting issues**, I want **migration scripts organized in migrations/ directory and diagnostic scripts organized in diagnostics/ directory**, so that **I can quickly find the right script without searching through 54 root-level files**.

---

## Acceptance Criteria

1. **migrations/ directory created** with README.md explaining:
   - Purpose: Database schema migration scripts
   - Naming convention: migrate_add_*.py
   - Usage: Run once per migration, then archive
   - List of all migrations with dates and purposes

2. **All migration scripts moved** from root to migrations/:
   - migrate_add_*.py (15+ files identified during analysis)
   - migrations/run_migration_001.py (already in migrations/, keep there)
   - Use `git mv` to preserve history

3. **diagnostics/ directory created** with README.md explaining:
   - Purpose: Scripts for checking system state and debugging
   - Naming convention: check_*.py, debug_*.py, diagnose_*.py
   - Usage: Run as needed for troubleshooting

4. **All diagnostic scripts moved** from root to diagnostics/:
   - check_*.py files (10+ files: check_ranking_history.py, check_bowl_games.py, etc.)
   - debug_*.py files (debug_championships.py, etc.)
   - diagnose_*.py files (diagnose_missing_games.py)
   - Use `git mv` to preserve history

5. **Import statements updated** in moved files:
   - Update relative imports to work from new locations
   - Test that each script can still import core modules (models, database, etc.)

6. **README.md updated** with new directory structure documented

---

## Integration Verification

- **IV1: Full Test Suite Pass** - Run all 124 tests - all must pass (tests may need import updates)
- **IV2: Test Import Updates** - Update test file imports if they reference moved migration scripts
- **IV3: Script Functionality** - Spot-check 3 moved scripts (1 migration, 2 diagnostics) to verify they still import and run without errors

---

## Dev Notes

### Previous Story Insights

**Story 28.4 Completed:**
- Import statements standardized across all files
- All 124 tests passing
- Clean baseline for file reorganization

**Dependency:**
- This story is the first file reorganization
- Establishes pattern for Stories 28.6 and 28.7

[Source: `docs/stories/28.4.story.md`]

### File Locations

**Migration Scripts to Move (15+ files):**
```
migrate_add_ap_poll_rankings.py
migrate_add_conference_name.py
migrate_add_fcs_fields.py
migrate_add_game_type.py
migrate_add_predictions.py
migrate_add_quarter_scores.py
migrate_add_transfer_portal_fields.py
... (and more)
```

**Diagnostic Scripts to Move (10+ files):**
```
check_*.py files:
- check_bowl_games.py
- check_conference_championships.py
- check_game_details.py
- check_playoff_games.py
- check_postseason_column.py
- check_prediction_accuracy.py
- check_production_schema.py
- check_ranking_history.py
- check_ranking_history_data.py
- check_team_games.py

debug_*.py files:
- debug_championships.py

diagnose_*.py files:
- diagnose_missing_games.py
```

**Existing migrations/ Directory:**
- Already contains: migrations/run_migration_001.py
- Keep existing file, add new migrations to this directory

[Source: Root directory file listing, `docs/prd.md`]

### Import Pattern Updates

**Before (from root):**
```python
# Script in root directory
from models import Team, Game
from database import get_db
import ranking_service
```

**After (from migrations/ or diagnostics/):**
```python
# Script in subdirectory
import sys
from pathlib import Path

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

# Now imports work
from models import Team, Game
from database import get_db
import ranking_service
```

**Alternative (cleaner):**
```python
# Script in subdirectory
from pathlib import Path
import sys

# Add root to path at the start
root_dir = Path(__file__).parent.parent
if str(root_dir) not in sys.path:
    sys.path.insert(0, str(root_dir))

from models import Team, Game
from database import get_db
```

[Source: Python import documentation]

### Technical Constraints

- **Use git mv** - Preserves file history for tracking
- **Update imports** - Scripts must still import core modules
- **Test thoroughly** - Verify moved scripts still work
- **README.md files** - Explain purpose and usage of each directory
- **No functional changes** - Only moving files and updating imports

[Source: `docs/prd.md#Technical Constraints`]

### Testing Requirements

**File Move Commands:**
```bash
# Create directories
mkdir migrations diagnostics

# Move migration scripts (use git mv)
git mv migrate_add_*.py migrations/

# Move diagnostic scripts
git mv check_*.py diagnostics/
git mv debug_*.py diagnostics/
git mv diagnose_*.py diagnostics/
```

**Import Update Pattern:**
Add to top of each moved script:
```python
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent))
```

**Test Moved Scripts:**
```bash
# Test a migration script (dry run if possible)
python migrations/migrate_add_predictions.py --help

# Test diagnostic scripts
python diagnostics/check_ranking_history.py
python diagnostics/debug_championships.py
```

**Integration Tests:**
```bash
# Run full test suite
pytest -v

# Check if tests import moved scripts
grep -r "migrate_add" tests/
grep -r "check_" tests/
```

[Source: `docs/EPIC-028-CODEBASE-CLEANUP.md#Story 28.5`]

---

## Tasks / Subtasks

1. **Create migrations/ Directory Structure** (20 minutes)
   - Create migrations/ directory if not exists
   - Create migrations/README.md explaining purpose
   - List all migration scripts with descriptions
   - Document naming convention and usage
   - (AC: 1)

2. **Move Migration Scripts** (30 minutes)
   - Identify all migrate_add_*.py files in root
   - Use `git mv` to move each to migrations/
   - Document count: `ls migrations/migrate_*.py | wc -l`
   - (AC: 2)

3. **Update Migration Script Imports** (45 minutes)
   - Add sys.path modification to each migration script
   - Test pattern: `python migrations/migrate_add_predictions.py --help`
   - Spot-check 3 scripts to verify imports work
   - (AC: 5)

4. **Create diagnostics/ Directory Structure** (20 minutes)
   - Create diagnostics/ directory
   - Create diagnostics/README.md explaining purpose
   - Document naming conventions (check_*, debug_*, diagnose_*)
   - Document usage and when to run each type
   - (AC: 3)

5. **Move Diagnostic Scripts** (30 minutes)
   - Use `git mv` for check_*.py files to diagnostics/
   - Use `git mv` for debug_*.py files to diagnostics/
   - Use `git mv` for diagnose_*.py files to diagnostics/
   - Document count: `ls diagnostics/*.py | wc -l`
   - (AC: 4)

6. **Update Diagnostic Script Imports** (45 minutes)
   - Add sys.path modification to each diagnostic script
   - Test pattern: `python diagnostics/check_ranking_history.py`
   - Spot-check 3 scripts to verify imports work
   - (AC: 5)

7. **Update README.md** (15 minutes)
   - Add migrations/ and diagnostics/ to project structure
   - Document purpose of each directory
   - Update any references to moved scripts
   - (AC: 6)

8. **Run Full Test Suite** (20 minutes)
   - Run `pytest -v` - all 124 tests must pass
   - Check if tests reference moved scripts: `grep -r "migrate_add" tests/`
   - Update test imports if needed
   - Re-run tests until all pass
   - (IV1, IV2)

9. **Verify Script Functionality** (20 minutes)
   - Test 1 migration script: `python migrations/migrate_add_predictions.py --help`
   - Test 2 diagnostic scripts: `python diagnostics/check_ranking_history.py`
   - Verify no ImportError exceptions
   - (IV3)

10. **Review and Commit** (15 minutes)
    - Review git diff (should show file moves and import updates)
    - Verify git mv preserved history: `git log --follow migrations/migrate_add_predictions.py`
    - Commit with message: "Reorganize migration and diagnostic scripts (Story 28.5)"
    - (AC: 1-6, IV1-IV3)

---

## Definition of Done

- [ ] migrations/ directory created with README.md
- [ ] All migration scripts moved to migrations/ (15+ files)
- [ ] diagnostics/ directory created with README.md
- [ ] All diagnostic scripts moved to diagnostics/ (10+ files)
- [ ] All moved scripts have updated imports
- [ ] README.md updated with new directory structure
- [ ] Full test suite passes (124 tests)
- [ ] Test imports updated if needed
- [ ] 3 moved scripts verified functional
- [ ] Git history preserved (git mv used)
- [ ] All acceptance criteria met (AC 1-6)
- [ ] All integration verifications pass (IV1-IV3)
- [ ] Changes committed with proper message

---

## Rollback Plan

**Risk Level:** ðŸŸ¡ Medium Risk (file moves can break imports)

**Rollback Steps:**
1. `git revert <commit-hash>` - Moves files back to root
2. Run test suite: `pytest -v` (verify rollback)
3. Verify scripts work: Test 3 scripts from root directory

**Rollback Impact:** Medium - if imports not updated correctly, moved scripts may not work. Thorough testing in this story mitigates risk.

---

## Notes

- **First file reorganization** - Establishes pattern for Stories 28.6 and 28.7
- **Git mv is critical** - Preserves file history for tracking changes
- **Import updates required** - Scripts need sys.path modification to import from root
- **15+ migration scripts** - Significant cleanup of root directory
- **10+ diagnostic scripts** - Further cleanup of root directory
- **Test thoroughly** - Verify moved scripts still work before committing
- **README files important** - Help developers understand purpose of each directory

---

**Related Documents:**
- Epic: `docs/EPIC-028-CODEBASE-CLEANUP.md`
- PRD: `docs/prd.md`
- Previous Story: `docs/stories/28.4.story.md`
- Next Story: `docs/stories/28.6.story.md`
