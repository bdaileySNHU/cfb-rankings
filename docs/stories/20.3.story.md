# Story 20.3: Add Ranking Badges to Prediction Cards (Optional Enhancement)

**Epic:** EPIC-020 - Reorder Game Predictions by Ranking
**Story:** 20.3
**Estimated Effort:** 3-4 hours
**Priority:** Optional (can be deferred)

---

## User Story

As a **college football fan viewing game predictions**,
I want **to see team rankings displayed in the prediction cards** (e.g., "#2 Ohio State vs #5 Penn State"),
So that **I immediately understand the quality and importance of each matchup without having to reference the rankings table**.

---

## Story Context

### Existing System Integration

- **Integrates with:**
  - `frontend/js/app.js` - `createPredictionCard()` function
  - `frontend/js/api.js` - `getRankings()` function
  - `frontend/css/style.css` - Existing rank badge styles
- **Technology:** JavaScript (ES6+), CSS styling, API data cross-referencing
- **Follows pattern:** Existing rank badge display in rankings table (`.rank-badge` classes)
- **Touch points:**
  - Fetch rankings data alongside predictions
  - Cross-reference team names between rankings and predictions
  - Add ranking badges to prediction card HTML
  - Style badges using existing CSS classes

### Current State

**Current Prediction Display:**
```
PREDICTED | Week 11 • TBD
-------------------------
Michigan State
24
@
Ohio State
32
-------------------------
Win Probability: ...
Confidence: Medium
```

**Desired Prediction Display:**
```
PREDICTED | Week 11 • TBD
-------------------------
#15 Michigan State
24
@
#2 Ohio State  ← Winner styling
32
-------------------------
Win Probability: ...
Confidence: Medium
```

**Existing Rank Badge Styles** (from rankings table):
- `.rank-badge.top-5` - Gold background
- `.rank-badge.top-10` - Silver background
- `.rank-badge.top-25` - Bronze background
- `.rank-badge` - Default styling

---

## Acceptance Criteria

### Functional Requirements

1. **Team rankings are displayed** in prediction cards using existing badge styles
2. **Badges show current ranking** at time of prediction load (e.g., "#2")
3. **Unranked teams** (outside top 25) show either no badge or "NR" (Not Ranked) indicator
4. **Rankings update** when predictions are refreshed
5. **Badge placement** is visually clear and doesn't clutter the card

### Integration Requirements

6. **Fetch rankings data** when loading predictions (additional API call to `/api/rankings?limit=200`)
7. **Cross-reference team names** between rankings and predictions to assign correct rank
8. **Cache rankings data** during the page session to minimize API calls
9. **Handle ranking mismatches** gracefully (team name spelling differences, FCS teams, etc.)
10. **Existing prediction card layout** is enhanced but not broken

### Quality Requirements

11. **Performance impact is minimal** - rankings fetched once per page load or refresh
12. **Visual styling matches** existing rank badge design from rankings table
13. **Responsive layout** - badges display correctly on mobile
14. **No console errors** if rankings data is unavailable

---

## Technical Implementation

### Changes Required

#### File 1: `frontend/js/app.js` - Update `loadPredictions()`

**Add rankings fetch:**
```javascript
async function loadPredictions(weekFilter = null, nextWeekOnly = true) {
  try {
    // Fetch predictions
    const predictions = await api.getPredictions(params);

    // === NEW: Fetch current rankings for badge display ===
    let rankingsMap = {};
    try {
      const rankings = await api.getRankings({ limit: 200 });
      // Create map of team name → rank for quick lookup
      rankingsMap = rankings.teams.reduce((map, team) => {
        map[team.team_name] = team.rank;
        return map;
      }, {});
    } catch (err) {
      console.warn('Could not load rankings for badges:', err);
      // Continue without rankings - just won't show badges
    }
    // === END NEW CODE ===

    // Sort predictions...
    predictions.sort(...);

    // Render predictions with rankings data
    predictions.forEach(pred => {
      const card = createPredictionCard(pred, rankingsMap); // Pass rankings
      container.appendChild(card);
    });
  } catch (err) {
    // ... error handling
  }
}
```

#### File 2: `frontend/js/app.js` - Update `createPredictionCard()`

**Add ranking badge display:**
```javascript
function createPredictionCard(prediction, rankingsMap = {}) {
  const card = document.createElement('div');
  card.className = 'prediction-card';

  // ... existing code ...

  // === NEW: Get team rankings ===
  const homeRank = rankingsMap[prediction.home_team];
  const awayRank = rankingsMap[prediction.away_team];

  // Create badge HTML (or empty string if unranked)
  const homeBadge = homeRank ? createRankBadge(homeRank) : '';
  const awayBadge = awayRank ? createRankBadge(awayRank) : '';
  // === END NEW CODE ===

  card.innerHTML = `
    <div class="prediction-header">
      <span class="prediction-badge">PREDICTED</span>
      <span class="game-info">Week ${prediction.week}${gameDate ? ' • ' + gameDate : ''}</span>
    </div>

    <div class="matchup">
      <div class="team away-team ${awayIsWinner ? 'predicted-winner' : ''}">
        ${awayBadge} <!-- NEW: Ranking badge -->
        <span class="team-name">${prediction.away_team}</span>
        <span class="score">${prediction.predicted_away_score}</span>
      </div>

      <div class="matchup-separator">
        <span class="at-symbol">@</span>
      </div>

      <div class="team home-team ${homeIsWinner ? 'predicted-winner' : ''}">
        ${homeBadge} <!-- NEW: Ranking badge -->
        <span class="team-name">${prediction.home_team}</span>
        <span class="score">${prediction.predicted_home_score}</span>
      </div>
    </div>

    <!-- ... rest of card ... -->
  `;

  return card;
}

// === NEW HELPER FUNCTION ===
function createRankBadge(rank) {
  let badgeClass = 'rank-badge';
  if (rank <= 5) badgeClass += ' top-5';
  else if (rank <= 10) badgeClass += ' top-10';
  else if (rank <= 25) badgeClass += ' top-25';

  return `<span class="${badgeClass}">#${rank}</span>`;
}
```

#### File 3: `frontend/css/style.css` - Add badge positioning in predictions

**Add CSS for badge placement:**
```css
/* Ranking badges in prediction cards */
.prediction-card .team .rank-badge {
  display: inline-block;
  margin-right: 0.5rem;
  font-size: 0.85rem;
  padding: 0.2rem 0.5rem;
  vertical-align: middle;
}

/* Adjust spacing on mobile */
@media (max-width: 768px) {
  .prediction-card .team .rank-badge {
    font-size: 0.75rem;
    margin-right: 0.3rem;
    padding: 0.15rem 0.4rem;
  }
}
```

### Data Flow

1. **User loads page** or clicks refresh
2. **`loadPredictions()` called**
   - Fetches predictions from `/api/predictions`
   - Fetches rankings from `/api/rankings?limit=200`
   - Creates `rankingsMap` object: `{ "Ohio State": 2, "Georgia": 1, ... }`
3. **For each prediction:**
   - Look up `prediction.home_team` in `rankingsMap` → get rank or undefined
   - Look up `prediction.away_team` in `rankingsMap` → get rank or undefined
   - Create badge HTML if rank exists
4. **Render prediction card** with badges included

### Edge Cases to Handle

**1. Team name mismatch:**
- API returns "Ohio State" but prediction has "Ohio St."
- **Solution:** Could add name normalization map if needed, or accept occasional misses

**2. FCS teams:**
- FCS teams don't appear in rankings
- **Solution:** No badge displayed (graceful degradation)

**3. Rankings API fails:**
- Network error, API down, etc.
- **Solution:** Catch error, log warning, continue without badges

**4. Unranked FBS teams:**
- Teams outside top 25 (or top 200 if fetching all)
- **Solution:** No badge displayed, or show "NR" badge with different styling

### Testing Checklist

**Functional Testing:**
- [ ] Load predictions - verify badges appear for ranked teams
- [ ] Unranked teams - verify no badge or "NR" badge
- [ ] Refresh predictions - verify badges update
- [ ] Select different week - verify badges update
- [ ] Disable network - verify graceful degradation (no badges, no errors)

**Visual Testing:**
- [ ] Badge styling matches rankings table
- [ ] Badge placement doesn't overlap team name
- [ ] Mobile layout - badges fit properly
- [ ] Top 5 teams have gold badge
- [ ] Top 10 have silver badge
- [ ] Top 25 have bronze badge

**Performance Testing:**
- [ ] Rankings fetch adds minimal delay (<500ms)
- [ ] Cached rankings used for subsequent renders
- [ ] No jank when rendering badges

**Edge Case Testing:**
- [ ] Team name mismatch - handle gracefully
- [ ] FCS team in prediction - no error
- [ ] Rankings API timeout - predictions still load
- [ ] Empty rankings response - predictions still load

---

## Technical Notes

### Integration Approach
- Add optional rankings parameter to `createPredictionCard()`
- Fetch rankings once per predictions load
- Cache rankings in session if possible (future enhancement)
- Use existing `.rank-badge` CSS classes for consistency

### Existing Pattern Reference
- Rankings table in `index.html` uses same `.rank-badge` classes
- Badge styles already defined in `frontend/css/style.css`
- Cross-referencing pattern similar to other data lookups

### Key Constraints
- **Rankings fetch must not block predictions** - if it fails, predictions still display
- **Team name matching must be exact** - no fuzzy matching (keep it simple)
- **Performance must not degrade** - rankings fetch should be fast

### Alternative Implementations Considered

**Option A: Include rankings in predictions API response**
- Pros: Single API call, perfect data matching
- Cons: Requires backend changes (violates EPIC-020 constraint)

**Option B (Chosen): Client-side cross-reference**
- Pros: No backend changes, flexible, optional enhancement
- Cons: Extra API call, potential name mismatches

**Option C: Only show top 10 rankings**
- Pros: Smaller API call
- Cons: Misses important matchups like #12 vs #15

### Rollback Plan
If badges cause issues:
1. Remove rankings fetch from `loadPredictions()`
2. Remove `rankingsMap` parameter from `createPredictionCard()`
3. Remove badge HTML from card template
4. Predictions work exactly as before

---

## Definition of Done

- [x] Functional requirements met
  - [ ] Ranking badges displayed in predictions
  - [ ] Badges show current rank
  - [ ] Unranked teams handled gracefully
  - [ ] Rankings update on refresh
  - [ ] Badge placement is clear
- [x] Integration requirements verified
  - [ ] Rankings API called successfully
  - [ ] Team names cross-referenced
  - [ ] Rankings data cached during session
  - [ ] Ranking mismatches handled
  - [ ] Existing layout not broken
- [x] Existing functionality regression tested
  - [ ] Predictions display with/without badges
  - [ ] All filters work
  - [ ] Performance acceptable
  - [ ] No console errors
- [x] Code follows existing patterns and standards
  - [ ] Uses existing badge CSS classes
  - [ ] Follows ranking fetch pattern
  - [ ] Clean code with comments
- [x] Tests pass (existing and new)
  - [ ] Visual testing complete
  - [ ] Edge cases tested
  - [ ] Performance verified
- [x] Documentation updated if applicable
  - [ ] Add comments for rankings fetch
  - [ ] Update EPIC-020 with completion notes

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Rankings API call fails, breaks prediction display

**Mitigation:**
- Wrap rankings fetch in try-catch
- Predictions continue to display without badges if rankings fail
- Log warnings instead of errors

**Rollback:** Remove rankings fetch and badge display code

### Compatibility Verification

- [x] No breaking changes to existing APIs (no backend changes)
- [x] Database changes (if any) are additive only (no database changes)
- [x] UI changes follow existing design patterns (uses existing badge styles)
- [x] Performance impact is minimal (one additional API call per refresh)

---

## Validation Checklist

### Scope Validation

- [x] Story can be completed in one development session (3-4 hours)
- [x] Integration approach is straightforward (fetch and cross-reference)
- [x] Follows existing patterns exactly (uses existing badge styles)
- [x] No design or architecture work required (optional enhancement)

### Clarity Check

- [x] Story requirements are unambiguous (clear badge display)
- [x] Integration points are clearly specified (predictions + rankings APIs)
- [x] Success criteria are testable (visual badges, edge cases)
- [x] Rollback approach is simple (remove rankings fetch)

---

## Implementation Notes for Developer

### Priority Note
**This story is OPTIONAL** and can be implemented after Stories 20.1 and 20.2 are complete and deployed. It's a nice-to-have visual enhancement but not critical for the core UX improvement.

### Step-by-Step Implementation

1. **Open** `frontend/js/app.js`
2. **Update** `loadPredictions()`:
   - Add rankings API call after predictions fetch
   - Create `rankingsMap` object
   - Handle rankings fetch failure gracefully
3. **Update** `createPredictionCard()`:
   - Add `rankingsMap` parameter (default to empty object)
   - Look up home/away team rankings
   - Create badge HTML
   - Insert badges in card template
4. **Add** `createRankBadge()` helper function
5. **Update** `frontend/css/style.css`:
   - Add badge positioning for prediction cards
   - Ensure mobile responsive
6. **Test** thoroughly:
   - Test with rankings available
   - Test with rankings API failure
   - Test with unranked teams
   - Test visual appearance
7. **Commit** with clear message about adding ranking badges

**Estimated Time:** 1 hour for code + 2-3 hours for testing = 3-4 hours total

### Visual Design Example

```
┌─────────────────────────────────────┐
│ PREDICTED | Week 11 • Sat, Nov 9   │
├─────────────────────────────────────┤
│  [#15]  Michigan State             │
│         24                          │
│                  @                  │
│  [#2]   Ohio State (highlighted)   │
│         32                          │
├─────────────────────────────────────┤
│ Win Prob: Ohio State: 73.9%        │
│ Confidence: Medium                  │
└─────────────────────────────────────┘

Badges:
[#2]  ← Gold background (top 5)
[#15] ← Bronze background (top 25)
```
