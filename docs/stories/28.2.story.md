# Story 28.2: Establish Coding Standards and Configure Tooling

**Status:** ðŸ“‹ To Do
**Epic:** EPIC-028 Comprehensive Codebase Cleanup
**Priority:** High
**Risk Level:** ðŸŸ¢ Very Low Risk
**Estimated Effort:** 2-3 hours

---

## Story

As a **developer maintaining the Stat-urday Synthesis codebase**, I want **documented coding standards and automated formatting/linting tools configured**, so that **code quality is consistent, reviews focus on logic rather than style, and technical debt is minimized**.

---

## Acceptance Criteria

1. **CODING-STANDARDS.md created** in docs/ with sections:
   - Python naming conventions (already used: snake_case functions, PascalCase classes)
   - PEP 8 compliance requirements
   - Import organization standards (standard lib â†’ third-party â†’ local, alphabetically sorted)
   - Docstring style guide (Google style with examples)
   - Type hints policy (encouraged for new code)
   - Error handling patterns (existing patterns documented)

2. **Black configuration** added to pyproject.toml:
   - Line length: 100 (to match existing code style)
   - Target Python version: 3.11

3. **Flake8 configuration** added to .flake8:
   - Max line length: 100 (consistent with Black)
   - Ignore common Black conflicts (E203, W503)
   - Exclude: migrations/, archive/, .venv/

4. **isort configuration** added to pyproject.toml:
   - Profile: black (compatibility)
   - Line length: 100
   - Known first party: src (for future reorganization)

5. **requirements-dev.txt updated** with development tools:
   - black>=23.0.0
   - flake8>=6.0.0
   - isort>=5.12.0

6. **Pre-commit hooks documentation** added to CONTRIBUTING.md (optional usage, not enforced)

---

## Integration Verification

- **IV1: Existing Code Compatibility** - Run black, flake8, isort in check mode on existing codebase to establish baseline (expect violations, document count)
- **IV2: No Code Changes** - Configuration only, no code formatting applied in this story
- **IV3: Tool Installation** - Verify all tools install correctly via `pip install -r requirements-dev.txt`

---

## Dev Notes

### Previous Story Insights

**Story 28.1 Completed:**
- CONTRIBUTING.md and DEVELOPMENT.md created
- Developer onboarding documentation established
- README.md updated with "For Developers" section

**Dependency:**
- This story adds pre-commit hooks documentation to CONTRIBUTING.md created in Story 28.1

[Source: `docs/stories/28.1.story.md`]

### File Locations

**New Files to Create:**
- `docs/CODING-STANDARDS.md` - Comprehensive coding standards documentation
- `pyproject.toml` - Black and isort configuration
- `.flake8` - Flake8 linting configuration

**Files to Modify:**
- `requirements-dev.txt` - Add black, flake8, isort
- `CONTRIBUTING.md` - Add optional pre-commit hooks section

**Existing Files (Reference Only):**
- Analyze existing code patterns in: main.py, ranking_service.py, models.py, schemas.py

[Source: `docs/architecture.md#Source Tree and Module Organization`]

### Coding Standards Content

#### CODING-STANDARDS.md Should Document:

1. **Python Naming Conventions (Existing Patterns)**
   - **Files**: snake_case.py (e.g., ranking_service.py, cfbd_client.py)
   - **Classes**: PascalCase (e.g., RankingService, Team, Game)
   - **Functions/Methods**: snake_case (e.g., calculate_elo, get_rankings)
   - **Variables**: snake_case (e.g., elo_rating, home_score)
   - **Constants**: UPPER_SNAKE_CASE (e.g., BASE_ELO, HOME_ADVANTAGE)
   - **Private methods**: _leading_underscore (e.g., _calculate_expected_score)

2. **PEP 8 Compliance**
   - Line length: 100 characters (verified from existing code)
   - Indentation: 4 spaces (no tabs)
   - Blank lines: 2 between top-level definitions, 1 between methods
   - Imports: One import per line (except from x import a, b)
   - Whitespace: Follow PEP 8 guidelines

3. **Import Organization**
   ```python
   # Standard library imports
   import os
   import sys
   from datetime import datetime

   # Third-party imports
   from fastapi import FastAPI, Depends
   from sqlalchemy.orm import Session

   # Local application imports
   from models import Team, Game
   from ranking_service import RankingService
   ```

4. **Docstring Style (Google Format)**
   ```python
   def calculate_elo_change(rating_diff: int, actual_score: float) -> float:
       """Calculate ELO rating change based on rating difference.

       Args:
           rating_diff: Difference between opponent and team rating
           actual_score: 1.0 for win, 0.0 for loss

       Returns:
           Rating change value (positive for gain, negative for loss)

       Example:
           >>> calculate_elo_change(100, 1.0)
           18.2
       """
   ```

5. **Type Hints Policy**
   - Encouraged for all new functions
   - Required for public API functions
   - Use standard library types where possible (list, dict, int, str)
   - Use typing module for complex types (Optional, Union, List, Dict)

6. **Error Handling Patterns**
   - Use try/except for expected errors
   - Log errors appropriately (logging module)
   - Raise HTTPException for API errors (FastAPI pattern)
   - Document raised exceptions in docstrings

[Source: Analyzed from `main.py:1-100`, `ranking_service.py:1-100`]

### Tool Configuration Specifications

#### pyproject.toml (Black + isort)
```toml
[tool.black]
line-length = 100
target-version = ['py311']
include = '\.pyi?$'
extend-exclude = '''
/(
  migrations
  | archive
  | \.venv
)/
'''

[tool.isort]
profile = "black"
line_length = 100
known_first_party = ["src"]
multi_line_output = 3
include_trailing_comma = true
force_grid_wrap = 0
use_parentheses = true
ensure_newline_before_comments = true
```

#### .flake8
```ini
[flake8]
max-line-length = 100
extend-ignore = E203, W503
exclude =
    .git,
    __pycache__,
    .venv,
    venv,
    migrations,
    archive,
    *.egg-info
```

[Source: Black documentation, isort documentation, flake8 documentation]

### Technical Constraints

- **Configuration only** - No code formatting applied in this story
- **Baseline establishment** - Run tools in check mode, document violations
- **Tool compatibility** - Ensure Black, flake8, isort work together
- **Exclude directories** - Don't lint migrations/, archive/, .venv/
- **Line length consistency** - 100 chars across all tools (matches existing code)

[Source: `docs/prd.md#Technical Constraints`]

### Testing Requirements

**Manual Verification:**
1. **Tool Installation**:
   ```bash
   pip install -r requirements-dev.txt
   # Verify black, flake8, isort installed
   black --version
   flake8 --version
   isort --version
   ```

2. **Baseline Establishment** (Check Mode Only):
   ```bash
   # Black - check formatting (don't apply)
   black --check .

   # Flake8 - check linting
   flake8 . | tee flake8-baseline.txt

   # isort - check imports (don't apply)
   isort --check-only --diff .
   ```

3. **Configuration Validation**:
   - Verify pyproject.toml syntax is valid
   - Verify .flake8 syntax is valid
   - Verify tools respect exclude directories

4. **Documentation Accuracy**:
   - Verify CODING-STANDARDS.md examples match actual code patterns
   - Verify naming conventions documented match codebase reality

**Integration Verification:**
- No code changes - `git diff` should show only config files and docs
- Tools install successfully - all commands run without errors
- Baseline documented - save violation counts for future reference

[Source: `docs/EPIC-028-CODEBASE-CLEANUP.md#Story 28.2`]

---

## Tasks / Subtasks

1. **Create CODING-STANDARDS.md** (60 minutes)
   - Document naming conventions (analyze existing code patterns)
   - Write PEP 8 compliance section
   - Document import organization with examples
   - Create docstring style guide with Google style examples
   - Document type hints policy
   - Document error handling patterns from existing code
   - (AC: 1)

2. **Configure Black (pyproject.toml)** (15 minutes)
   - Create pyproject.toml if it doesn't exist
   - Add [tool.black] section with line-length=100, target-version py311
   - Add exclude pattern for migrations/, archive/, .venv/
   - Test configuration: `black --check .` (don't apply)
   - (AC: 2)

3. **Configure isort (pyproject.toml)** (15 minutes)
   - Add [tool.isort] section to pyproject.toml
   - Set profile=black, line_length=100, known_first_party=src
   - Test configuration: `isort --check-only .` (don't apply)
   - (AC: 4)

4. **Configure Flake8 (.flake8)** (15 minutes)
   - Create .flake8 configuration file
   - Set max-line-length=100, extend-ignore=E203,W503
   - Add exclude pattern for migrations/, archive/, .venv/
   - Test configuration: `flake8 .`
   - (AC: 3)

5. **Update requirements-dev.txt** (10 minutes)
   - Add black>=23.0.0
   - Add flake8>=6.0.0
   - Add isort>=5.12.0
   - Test installation: `pip install -r requirements-dev.txt`
   - (AC: 5)

6. **Update CONTRIBUTING.md** (15 minutes)
   - Add "Code Quality Tools (Optional)" section
   - Document how to run black, flake8, isort
   - Explain pre-commit hooks (optional, not enforced)
   - Add commands for check-only mode
   - (AC: 6)

7. **Establish Baseline** (20 minutes)
   - Run `black --check .` - save output to baseline report
   - Run `flake8 . | tee flake8-baseline.txt` - document violation count
   - Run `isort --check-only --diff .` - save output to baseline report
   - Document baseline in CODING-STANDARDS.md "Current State" section
   - (IV1)

8. **Review and Verify** (10 minutes)
   - Verify all tools install without errors
   - Verify configurations are syntactically correct
   - Verify no code was modified (only config and docs)
   - Run git diff to confirm only expected files changed
   - Commit with message: "Establish coding standards and configure tooling (Story 28.2)"
   - (AC: 1-6, IV1-IV3)

---

## Definition of Done

- [ ] CODING-STANDARDS.md created with all required sections
- [ ] pyproject.toml created with Black and isort configuration
- [ ] .flake8 created with Flake8 configuration
- [ ] requirements-dev.txt updated with development tools
- [ ] CONTRIBUTING.md updated with code quality tools section
- [ ] Baseline established (violation counts documented)
- [ ] All tools install successfully
- [ ] No code changes (configuration only)
- [ ] All acceptance criteria met (AC 1-6)
- [ ] All integration verifications pass (IV1-IV3)
- [ ] Changes committed with proper message

---

## Rollback Plan

**Risk Level:** ðŸŸ¢ Very Low Risk (configuration only)

**Rollback Steps:**
1. `git revert <commit-hash>` - Removes all configuration files
2. Verify pyproject.toml, .flake8 removed
3. Verify requirements-dev.txt restored
4. Verify CODING-STANDARDS.md removed
5. Verify CONTRIBUTING.md restored to Story 28.1 state

**Rollback Impact:** None - configuration only, no code affected

---

## Notes

- **Baseline establishment is critical** - Document current violations before applying any formatting
- **Configuration only** - Resist temptation to run formatting in this story
- **Line length 100** - Analyzed existing code, most files already follow this
- **Tool compatibility** - Black, flake8, isort configured to work together without conflicts
- **Optional tooling** - Tools documented but not enforced (no git hooks yet)
- **Foundation for Story 28.3** - Docstring standards documented here, applied in next story

---

**Related Documents:**
- Epic: `docs/EPIC-028-CODEBASE-CLEANUP.md`
- PRD: `docs/prd.md`
- Previous Story: `docs/stories/28.1.story.md`
- Architecture: `docs/architecture.md`
