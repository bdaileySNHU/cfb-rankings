# Story 24.1: Fix Current Season (2025) Team Records

**Epic:** EPIC-024 - Season-Specific Team Records
**Story:** 24.1
**Priority:** P0 - Critical Bug Fix
**Estimated Effort:** 2-3 hours

---

## User Story

As a **site visitor**,
I want **current season rankings to show accurate win-loss records**,
So that **I can trust the data and make informed assessments of team performance**.

---

## Problem Statement

### Current Broken State (2025 Week 14)

**Rankings Page Shows:**
- Oregon: 22-1 FBS (impossible - only 14 weeks played)
- Notre Dame: 21-3 FBS (wrong)
- Ohio State: 21-2 FBS (wrong)
- Georgia: 20-3 FBS (wrong)
- Texas: 20-5 FBS (same as 2024 end-of-season)
- Indiana: 21-1 FBS (wrong)

**Root Cause:**
- Teams table `wins` and `losses` fields are cumulative across all seasons
- Records include games from 2024 + 2025
- No season reset occurred when 2025 started

**Impact:**
- Users see incorrect records
- Rankings may be miscalculated
- Trust in data is compromised
- Historical browsing is broken

---

## Acceptance Criteria

### Functional Requirements

1. **2025 records are accurate**
   - Each team's record matches actual 2025 games played
   - Oregon shows correct W-L (not 22-1)
   - All teams show only 2025 season games

2. **Records calculated from game results**
   - Query `games` table WHERE season=2025
   - Count wins and losses per team
   - Update `teams` table with correct values

3. **Rankings display correctly**
   - Rankings page shows accurate 2025 records
   - Team pages show accurate 2025 records
   - No cross-season contamination

### Validation Requirements

4. **Verification checks pass**
   - No team has more games than weeks played
   - Sum of wins + losses ≤ current week number
   - Spot-check sample teams against schedule

---

## Technical Implementation

### Script Approach

Create `fix_2025_records.py` script to:

1. **Count actual 2025 games per team**
   ```python
   for each team:
       home_games = query games WHERE home_team_id = team.id AND season = 2025
       away_games = query games WHERE away_team_id = team.id AND season = 2025

       wins = 0
       losses = 0

       for game in (home_games + away_games):
           if not game.is_processed:
               continue  # Skip future games

           if team won game:
               wins += 1
           else:
               losses += 1

       team.wins = wins
       team.losses = losses
       db.commit()
   ```

2. **Verify results**
   ```python
   # Check no team has > 14 games in week 14
   # Check sample teams match expected records
   # Print summary report
   ```

3. **Backup before changes**
   ```bash
   # Create database backup
   cp cfb_rankings.db cfb_rankings.db.backup_before_24.1
   ```

### Implementation Code

```python
#!/usr/bin/env python3
"""
Fix 2025 team records - Story 24.1

Problem: Teams table has cumulative records across seasons
Solution: Recalculate wins/losses from 2025 games only
"""

from database import SessionLocal
from models import Team, Game
import sys


def fix_2025_records():
    """Recalculate team records for 2025 season"""

    db = SessionLocal()
    season = 2025

    print("="*80)
    print("FIX 2025 TEAM RECORDS - Story 24.1")
    print("="*80)
    print()
    print("⚠️  WARNING: This will update all team win/loss records")
    print()

    # Get all teams
    teams = db.query(Team).all()

    print(f"Processing {len(teams)} teams...")
    print()

    updated_count = 0

    for team in teams:
        # Get all 2025 games for this team
        games = db.query(Game).filter(
            ((Game.home_team_id == team.id) | (Game.away_team_id == team.id)),
            Game.season == season,
            Game.is_processed == True
        ).all()

        wins = 0
        losses = 0

        for game in games:
            # Determine if team won or lost
            is_home = game.home_team_id == team.id

            if is_home:
                if game.home_score > game.away_score:
                    wins += 1
                else:
                    losses += 1
            else:
                if game.away_score > game.home_score:
                    wins += 1
                else:
                    losses += 1

        # Check if record changed
        old_record = f"{team.wins}-{team.losses}"
        new_record = f"{wins}-{losses}"

        if team.wins != wins or team.losses != losses:
            print(f"  {team.name:30} {old_record:8} → {new_record:8} ({len(games)} games)")
            team.wins = wins
            team.losses = losses
            updated_count += 1

    # Commit changes
    db.commit()

    print()
    print("="*80)
    print(f"✓ Updated {updated_count} teams")
    print("="*80)
    print()

    # Verification
    print("VERIFICATION:")
    print()

    # Check for impossible records
    max_week = db.query(Game).filter(Game.season == season).order_by(Game.week.desc()).first().week

    teams_with_issues = db.query(Team).filter(
        (Team.wins + Team.losses) > max_week
    ).all()

    if teams_with_issues:
        print("⚠️  WARNING: Teams with impossible records:")
        for team in teams_with_issues:
            print(f"  - {team.name}: {team.wins}-{team.losses} (>{max_week} games)")
    else:
        print("✓ All teams have valid records (<= max week)")

    print()

    # Show top 10
    print("Top 10 teams by wins:")
    top_teams = db.query(Team).order_by(Team.wins.desc()).limit(10).all()
    for i, team in enumerate(top_teams, 1):
        print(f"  {i:2}. {team.name:30} {team.wins}-{team.losses}")

    print()

    db.close()

    return 0


if __name__ == "__main__":
    print()
    response = input("Continue with fixing 2025 records? (yes/no): ")
    if response.lower() != 'yes':
        print("Aborted")
        sys.exit(1)

    print()
    sys.exit(fix_2025_records())
```

---

## Testing Checklist

### Pre-Deployment Testing (Dev)

- [ ] Backup database
- [ ] Run script in dev environment
- [ ] Verify sample teams (Oregon, Texas, Georgia)
- [ ] Check no team has > current week games
- [ ] Verify rankings display correctly

### Production Deployment

- [ ] Backup production database
- [ ] Run script on production
- [ ] Verify rankings page
- [ ] Check multiple team pages
- [ ] Confirm no errors in logs

### Post-Deployment Verification

- [ ] Oregon shows correct 2025 record (not 22-1)
- [ ] Texas shows correct 2025 record (not 20-5)
- [ ] Rankings page displays accurate records
- [ ] No team has impossible record
- [ ] Sample team pages show correct data

---

## Rollback Plan

If issues occur:

```bash
# Restore database backup
cp cfb_rankings.db.backup_before_24.1 cfb_rankings.db

# Restart services
sudo systemctl restart cfb-rankings.service
```

---

## Success Metrics

**Immediate:**
- ✅ All teams show 2025-only records
- ✅ Zero teams with >14 games in Week 14
- ✅ Rankings page displays correctly

**Validation:**
- ✅ Oregon record matches schedule
- ✅ Texas record matches schedule
- ✅ Spot-check 5 random teams - all correct

---

## Known Limitations

**This is a stopgap fix:**
- Only fixes current season (2025)
- Teams table still stores single record (not per-season)
- Next season will have same issue unless Story 24.2 implemented
- Historical seasons (2024, etc.) remain incorrect in teams table

**Follow-up Required:**
- Story 24.2: Refactor to use ranking_history for all displays
- Story 24.3: Season management automation

---

## Related Files

**Script:** `fix_2025_records.py` (to be created)
**Database:** `teams` table (wins, losses columns)
**Affected Displays:**
- Rankings page
- Team detail pages
- Any display using teams.wins or teams.losses

---

## Definition of Done

- [ ] Script created and tested in dev
- [ ] Database backup created
- [ ] Script run on production
- [ ] All acceptance criteria met
- [ ] Rankings page verified correct
- [ ] Documentation updated
- [ ] Story marked complete

---

**Story Owner:** Development Team
**Related:** EPIC-024, Story 22.2 (discovered issue)
**Created:** 2025-11-30
