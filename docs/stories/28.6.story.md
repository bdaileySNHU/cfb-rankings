# Story 28.6: Reorganize Core Application Code into src/ Structure

**Status:** ðŸ“‹ To Do
**Epic:** EPIC-028 Comprehensive Codebase Cleanup
**Priority:** High
**Risk Level:** ðŸŸ  Medium-High Risk
**Estimated Effort:** 6-8 hours

---

## Story

As a **developer working on the Stat-urday Synthesis application logic**, I want **core application code organized into a src/ directory with logical subdirectories (api/, core/, models/, integrations/)**, so that **the codebase has clear separation of concerns and follows modern Python project structure conventions**.

---

## Acceptance Criteria

1. **src/ directory structure created**:
   ```
   src/
   â”œâ”€â”€ __init__.py
   â”œâ”€â”€ api/
   â”‚   â”œâ”€â”€ __init__.py
   â”‚   â””â”€â”€ main.py (moved from root)
   â”œâ”€â”€ core/
   â”‚   â”œâ”€â”€ __init__.py
   â”‚   â”œâ”€â”€ ranking_service.py (moved from root)
   â”‚   â”œâ”€â”€ ap_poll_service.py (moved from root)
   â”‚   â””â”€â”€ transfer_portal_service.py (moved from root)
   â”œâ”€â”€ models/
   â”‚   â”œâ”€â”€ __init__.py
   â”‚   â”œâ”€â”€ database.py (moved from root)
   â”‚   â”œâ”€â”€ models.py (moved from root)
   â”‚   â””â”€â”€ schemas.py (moved from root)
   â””â”€â”€ integrations/
       â”œâ”€â”€ __init__.py
       â””â”€â”€ cfbd_client.py (moved from root)
   ```

2. **All files moved using `git mv`** to preserve history

3. **Import statements updated comprehensively**:
   - All imports of moved modules updated throughout codebase
   - Example: `from models import Team` â†’ `from src.models.models import Team`
   - Example: `import ranking_service` â†’ `from src.core import ranking_service`
   - Use automated refactoring tools (rope, bowler) or careful search/replace

4. **__init__.py files created** to make directories proper Python packages

5. **gunicorn_config.py updated** if needed (or kept in root with updated import paths)

6. **Import statements in tests/ updated** to reference new src/ structure

7. **pytest.ini updated** if needed for test discovery from new structure

8. **README.md and DEVELOPMENT.md updated** with new directory structure

---

## Integration Verification

- **IV1: Full Test Suite Pass** - Run all 124 tests - ALL must pass (critical validation)
- **IV2: Application Startup** - Start backend with updated command (may need `python -m src.api.main` or update gunicorn config) - must start without errors
- **IV3: API Endpoint Functionality** - Test 5 key endpoints (GET /api/rankings, GET /api/teams, POST /api/games, GET /api/predictions, GET /api/admin/api-usage) - all must respond correctly
- **IV4: Frontend Integration** - Load frontend in browser, verify all pages load and API calls work (rankings page, team detail, predictions, comparison)

---

## Dev Notes

### Previous Story Insights

**Story 28.5 Completed:**
- Migration and diagnostic scripts reorganized
- Pattern established for file moves with git mv
- Import update pattern tested and verified

**Dependency:**
- This is the most complex file reorganization
- Affects core application files heavily imported elsewhere
- Requires comprehensive import updates across entire codebase

[Source: `docs/stories/28.5.story.md`]

### File Locations

**Files to Move:**

**API Layer (src/api/):**
- `main.py` â†’ `src/api/main.py`

**Business Logic Layer (src/core/):**
- `ranking_service.py` â†’ `src/core/ranking_service.py`
- `ap_poll_service.py` â†’ `src/core/ap_poll_service.py`
- `transfer_portal_service.py` â†’ `src/core/transfer_portal_service.py`
- `cfb_elo_ranking.py` â†’ `src/core/cfb_elo_ranking.py` (or utilities/)

**Data Layer (src/models/):**
- `models.py` â†’ `src/models/models.py`
- `schemas.py` â†’ `src/models/schemas.py`
- `database.py` â†’ `src/models/database.py`

**External Integrations (src/integrations/):**
- `cfbd_client.py` â†’ `src/integrations/cfbd_client.py`

**Files to Keep in Root:**
- `import_real_data.py` (main data import entry point)
- `gunicorn_config.py` (deployment config)
- Configuration files (.env, requirements.txt, pytest.ini, etc.)

[Source: `docs/prd.md#Code Organization`]

### Import Update Patterns

**Pattern 1: Updating Imports Within Moved Files**

Before (main.py in root):
```python
from models import Team, Game
from database import get_db
import ranking_service
```

After (src/api/main.py):
```python
from src.models.models import Team, Game
from src.models.database import get_db
from src.core import ranking_service
```

**Pattern 2: Updating Imports in Tests**

Before (tests/test_api.py):
```python
from main import app
from models import Team
from database import get_db
```

After (tests/test_api.py):
```python
from src.api.main import app
from src.models.models import Team
from src.models.database import get_db
```

**Pattern 3: Updating Imports in Root Scripts**

Before (import_real_data.py in root):
```python
from models import Team, Season
from cfbd_client import CFBDClient
```

After (import_real_data.py still in root):
```python
from src.models.models import Team, Season
from src.integrations.cfbd_client import CFBDClient
```

[Source: Python packaging best practices]

### Automated Refactoring Tools

**Option 1: rope (Python refactoring library)**
```bash
# Install rope
pip install rope

# Use rope to update imports
python -c "
from rope.base.project import Project
from rope.refactor.move import MoveModule

project = Project('.')
# ... use rope API to move and update imports
"
```

**Option 2: Manual search/replace with verification**
```bash
# Find all imports of models
grep -r "from models import" .
grep -r "import models" .

# Replace with sed or manually
# Verify with test suite after each change
```

**Recommended: Manual with test verification**
- More control and visibility
- Test suite validates each change
- Easier to debug if issues arise

[Source: Python rope documentation]

### Technical Constraints

- **Preserve git history** - Use git mv for all file moves
- **Comprehensive import updates** - Every import must be updated
- **Package structure** - __init__.py files make directories proper packages
- **Test suite validation** - All 124 tests must pass
- **Application startup** - Backend must start without errors
- **Frontend compatibility** - API endpoints must respond identically

[Source: `docs/prd.md#Technical Constraints`]

### Testing Requirements

**Critical Testing Sequence:**
1. Move files with git mv
2. Create __init__.py files
3. Update imports in moved files
4. Run tests - expect failures
5. Update imports in test files
6. Run tests - expect fewer failures
7. Update imports in root scripts
8. Run tests - should pass
9. Test application startup
10. Test API endpoints
11. Test frontend integration

**Comprehensive Test Commands:**
```bash
# After each import update phase, run:
pytest -v

# Verify imports work:
python -c "from src.api.main import app; print('API imports OK')"
python -c "from src.core.ranking_service import RankingService; print('Core imports OK')"
python -c "from src.models.models import Team; print('Models imports OK')"

# Start backend (may need new command):
python -m src.api.main
# OR update gunicorn_config.py and use:
gunicorn src.api.main:app

# Test API endpoints:
curl http://localhost:8000/api/rankings
curl http://localhost:8000/api/teams
curl http://localhost:8000/api/predictions

# Test frontend in browser:
open http://localhost:8000/frontend/
```

[Source: `docs/EPIC-028-CODEBASE-CLEANUP.md#Story 28.6`]

---

## Tasks / Subtasks

1. **Create src/ Directory Structure** (20 minutes)
   - Create src/, src/api/, src/core/, src/models/, src/integrations/
   - Create __init__.py in each directory
   - (AC: 1, 4)

2. **Move Core Files with git mv** (30 minutes)
   - `git mv main.py src/api/`
   - `git mv ranking_service.py ap_poll_service.py transfer_portal_service.py src/core/`
   - `git mv models.py schemas.py database.py src/models/`
   - `git mv cfbd_client.py src/integrations/`
   - Verify history preserved: `git log --follow src/api/main.py`
   - (AC: 1, 2)

3. **Update Imports in Moved Files** (90 minutes)
   - Update src/api/main.py imports (all core module imports)
   - Update src/core/ranking_service.py imports
   - Update src/core/ap_poll_service.py imports
   - Update src/models/models.py imports (if any)
   - Update src/integrations/cfbd_client.py imports (if any)
   - Run quick test after each: `python -c "from src.api.main import app"`
   - (AC: 3)

4. **Update Imports in Test Files** (90 minutes)
   - Find all test files: `find tests/ -name "*.py"`
   - Update conftest.py imports
   - Update factories.py imports
   - Update all test files (unit, integration, e2e)
   - Pattern: `from models import` â†’ `from src.models.models import`
   - Run tests incrementally: `pytest tests/unit/ -v`
   - (AC: 6)

5. **Update Imports in Root Scripts** (60 minutes)
   - Update import_real_data.py imports
   - Update seed_data.py imports (if not moved to utilities/)
   - Update any other root scripts
   - Update scripts/ directory scripts if they import moved modules
   - (AC: 3)

6. **Update gunicorn_config.py** (15 minutes)
   - Update to reference src.api.main:app
   - OR keep as-is and update systemd service instead
   - Test: `gunicorn -c gunicorn_config.py src.api.main:app`
   - (AC: 5)

7. **Update pytest.ini** (10 minutes)
   - Add pythonpath if needed: `pythonpath = .`
   - Verify test discovery: `pytest --collect-only`
   - (AC: 7)

8. **Run Full Test Suite** (30 minutes)
   - Run `pytest -v` - ALL 124 tests MUST pass
   - If failures, debug import errors
   - Fix remaining import issues
   - Re-run until all pass
   - (IV1)

9. **Verify Application Startup** (20 minutes)
   - Start backend: `python -m src.api.main` OR `gunicorn ...`
   - Verify starts without errors
   - Check logs for import errors
   - (IV2)

10. **Test API Endpoints** (20 minutes)
    - Test GET /api/rankings: `curl http://localhost:8000/api/rankings`
    - Test GET /api/teams: `curl http://localhost:8000/api/teams`
    - Test POST /api/games (with test data)
    - Test GET /api/predictions
    - Test GET /api/admin/api-usage
    - All must return correct JSON responses
    - (IV3)

11. **Test Frontend Integration** (20 minutes)
    - Load http://localhost:8000/frontend/ in browser
    - Navigate to rankings page - verify loads
    - Navigate to team detail page - verify loads
    - Navigate to predictions page - verify loads
    - Navigate to comparison page - verify loads
    - Verify all API calls succeed (check browser console)
    - (IV4)

12. **Update Documentation** (20 minutes)
    - Update README.md project structure section
    - Update DEVELOPMENT.md with new import patterns
    - Document new application startup command
    - (AC: 8)

13. **Review and Commit** (20 minutes)
    - Review comprehensive git diff
    - Verify all imports updated correctly
    - Verify test suite passes
    - Verify application works end-to-end
    - Commit with message: "Reorganize core application code into src/ structure (Story 28.6)"
    - (AC: 1-8, IV1-IV4)

---

## Definition of Done

- [ ] src/ directory structure created with subdirectories
- [ ] All core files moved to src/ with git mv
- [ ] All __init__.py files created
- [ ] Imports updated in all moved files
- [ ] Imports updated in all test files
- [ ] Imports updated in all root scripts
- [ ] gunicorn_config.py updated
- [ ] pytest.ini updated if needed
- [ ] README.md and DEVELOPMENT.md updated
- [ ] Full test suite passes (ALL 124 tests)
- [ ] Backend starts without errors
- [ ] All 5 key API endpoints work correctly
- [ ] Frontend loads and all pages work
- [ ] Git history preserved for moved files
- [ ] All acceptance criteria met (AC 1-8)
- [ ] All integration verifications pass (IV1-IV4)
- [ ] Changes committed with proper message

---

## Rollback Plan

**Risk Level:** ðŸŸ  Medium-High Risk (most complex reorganization)

**Rollback Steps:**
1. `git revert <commit-hash>` - Moves files back to root, restores imports
2. Run test suite: `pytest -v` (verify all tests pass)
3. Start backend: `python main.py` (verify application works)
4. Test API endpoints manually
5. Test frontend in browser

**Rollback Impact:** Medium-High - If imports not comprehensive updated, application will be broken. Thorough testing in this story is critical to minimize risk.

**Mitigation:**
- Test incrementally after each import update phase
- Keep git commits clean for easy rollback
- Test in development environment before production

---

## Notes

- **Most complex story in epic** - Touches nearly every file in codebase
- **Highest risk** - Import errors can break entire application
- **Test incrementally** - Run tests after each phase of import updates
- **Automated tools optional** - Manual updates with test validation may be safer
- **Take time** - This story justifies the 6-8 hour estimate
- **Critical validation** - All 4 integration verifications (IV1-IV4) must pass
- **Foundation for modern structure** - Establishes professional Python project layout
- **Clear separation of concerns** - api/, core/, models/, integrations/ are logical

---

**Related Documents:**
- Epic: `docs/EPIC-028-CODEBASE-CLEANUP.md`
- PRD: `docs/prd.md`
- Previous Story: `docs/stories/28.5.story.md`
- Next Story: `docs/stories/28.7.story.md`
- Python Packaging: https://packaging.python.org/en/latest/
