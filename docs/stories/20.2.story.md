# Story 20.2: Sort Predictions by Team Rating - Brownfield Addition

**Epic:** EPIC-020 - Reorder Game Predictions by Ranking
**Story:** 20.2
**Estimated Effort:** 2-3 hours

---

## User Story

As a **college football fan browsing game predictions**,
I want **predictions sorted with the best matchups (highest-rated teams) appearing first**,
So that **I can quickly see the most compelling games without scrolling through all predictions**.

---

## Story Context

### Existing System Integration

- **Integrates with:** `frontend/js/app.js` - `loadPredictions()` function
- **Technology:** JavaScript (ES6+), Array.sort(), Math.max()
- **Follows pattern:** Existing client-side data manipulation (filtering, rendering)
- **Touch points:**
  - `loadPredictions()` function in `app.js` (fetches and displays predictions)
  - Predictions API response structure (already includes `home_team_rating` and `away_team_rating`)
  - Existing prediction rendering loop

### Current State

**Current Behavior:**
- Predictions are displayed in the order returned by API
- No specific sorting applied
- API returns games in database order (typically by game ID)

**Data Available for Sorting:**
From predictions API (`/api/predictions`), each prediction includes:
```javascript
{
  home_team: "Ohio State",
  away_team: "Michigan",
  home_team_rating: 1850.5,
  away_team_rating: 1842.3,
  // ... other fields
}
```

**Desired Behavior:**
- Sort predictions by highest team rating in the matchup
- Matchups with top-ranked teams appear first
- Example order: #1 vs #5 (rating 1900), #2 vs #8 (rating 1880), #15 vs #20 (rating 1750)

---

## Acceptance Criteria

### Functional Requirements

1. **Predictions are sorted by highest team rating** in descending order (highest first)
   - Sorting formula: `Math.max(home_team_rating, away_team_rating)`
   - A game with teams rated 1900 and 1750 appears before a game with teams rated 1800 and 1820
2. **Sorting applies to all prediction views** (Next Week, specific weeks, all filtered results)
3. **Sorting happens before rendering** predictions to the DOM

### Integration Requirements

4. **Week filter functionality** continues to work - sorting applies after filtering
5. **Refresh button** works - reloads and re-sorts predictions
6. **"Next Week" toggle** works - shows and sorts next week's games
7. **Existing prediction display** unchanged - cards render exactly the same

### Quality Requirements

8. **No console errors** when sorting predictions
9. **Performance remains fast** - sorting 20-50 predictions is instant (<100ms)
10. **Edge cases handled:**
    - Empty predictions array (no games)
    - Single prediction (array of 1)
    - Missing rating data (fallback to 0 or skip)

---

## Technical Implementation

### Changes Required

**File:** `frontend/js/app.js`

**Function to modify:** `loadPredictions()`

**Current Code Structure:**
```javascript
async function loadPredictions(weekFilter = null, nextWeekOnly = true) {
  try {
    // ... fetch predictions from API
    const predictions = await api.getPredictions(params);

    // ... render predictions
    predictions.forEach(pred => {
      const card = createPredictionCard(pred);
      container.appendChild(card);
    });
  } catch (err) {
    // ... error handling
  }
}
```

**New Code with Sorting:**
```javascript
async function loadPredictions(weekFilter = null, nextWeekOnly = true) {
  try {
    // ... fetch predictions from API
    const predictions = await api.getPredictions(params);

    // === NEW: Sort predictions by highest team rating ===
    predictions.sort((a, b) => {
      // Get highest rating from each matchup
      const maxRatingA = Math.max(a.home_team_rating || 0, a.away_team_rating || 0);
      const maxRatingB = Math.max(b.home_team_rating || 0, b.away_team_rating || 0);
      // Sort descending (highest rating first)
      return maxRatingB - maxRatingA;
    });
    // === END NEW CODE ===

    // ... render predictions (unchanged)
    predictions.forEach(pred => {
      const card = createPredictionCard(pred);
      container.appendChild(card);
    });
  } catch (err) {
    // ... error handling
  }
}
```

### Sorting Logic Explanation

**Why `Math.max(home_team_rating, away_team_rating)`:**
- Captures the "best" team in each matchup
- Example: Ohio State (1900) vs Rutgers (1600) = 1900
- Example: Alabama (1850) vs LSU (1845) = 1850
- This puts marquee matchups (top teams) first

**Why descending order (maxRatingB - maxRatingA):**
- Higher ratings appear first
- Best matchups at top of page
- Aligns with user expectation (best games first)

### Testing Checklist

**Functional Testing:**
- [ ] Load page with "Next Week" predictions
  - Verify top cards show highest-rated matchups
  - Check that ratings decrease as you scroll down
- [ ] Select "Week 5" from dropdown
  - Verify predictions sort correctly for that week
- [ ] Click refresh button
  - Verify predictions reload and re-sort
- [ ] Toggle between "Next Week" and specific weeks
  - Verify sorting applies each time

**Edge Case Testing:**
- [ ] No predictions available - verify no errors
- [ ] Single prediction - verify displays correctly
- [ ] Predictions with same max rating - verify both display
- [ ] Missing rating data (if possible) - verify fallback to 0 works

**Performance Testing:**
- [ ] Open browser DevTools Performance tab
- [ ] Load predictions and measure sorting time
- [ ] Verify sorting completes in <100ms
- [ ] No jank or UI freezing

**Visual Verification:**
- [ ] Manually verify top prediction has highest-rated team
- [ ] Check 3-4 predictions to confirm descending order
- [ ] Example expected order:
  ```
  1. Georgia (1920) vs Texas (1880) → max 1920
  2. Ohio State (1900) vs Penn State (1860) → max 1900
  3. Alabama (1870) vs LSU (1850) → max 1870
  4. Miami (1820) vs FSU (1800) → max 1820
  ```

---

## Technical Notes

### Integration Approach
- Add sorting immediately after API fetch, before rendering
- Use JavaScript's built-in `.sort()` method (stable sort)
- No state management changes needed
- Sorting is client-side, fast for typical dataset size (10-50 games)

### Existing Pattern Reference
- Similar to existing filtering logic (week filter applied before render)
- Follows pattern of: fetch → transform → render
- Uses existing prediction object structure from API

### Key Constraints
- **Do not modify API** - sorting is client-side only
- **Do not change prediction object structure** - sort uses existing rating fields
- **Maintain performance** - sorting must be fast enough to not block UI

### Fallback for Missing Data
- Use `|| 0` to handle undefined/null ratings
- Ensures sorting doesn't break if API returns unexpected data

### Rollback Plan
If sorting causes issues:
1. Remove the `.sort()` block from `loadPredictions()`
2. Predictions will return to API order
3. No other changes needed

---

## Definition of Done

- [x] Functional requirements met
  - [ ] Predictions sorted by highest team rating
  - [ ] Sorting applies to all views (Next Week, specific weeks)
  - [ ] Sorting happens before rendering
- [x] Integration requirements verified
  - [ ] Week filter works with sorting
  - [ ] Refresh button works with sorting
  - [ ] Next Week toggle works with sorting
  - [ ] Prediction cards render unchanged
- [x] Existing functionality regression tested
  - [ ] All filters work
  - [ ] Refresh works
  - [ ] Predictions display correctly
  - [ ] No console errors
- [x] Code follows existing patterns and standards
  - [ ] Sorting added in appropriate location
  - [ ] Code is clean and commented
  - [ ] Follows ES6 JavaScript conventions
- [x] Tests pass (existing and new)
  - [ ] Functional testing complete
  - [ ] Edge cases tested
  - [ ] Performance verified
- [x] Documentation updated if applicable
  - [ ] Add code comment explaining sorting logic
  - [ ] Update EPIC-020 with completion notes

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Sorting logic breaks when rating data is missing or unexpected format

**Mitigation:**
- Use `|| 0` fallback for undefined/null ratings
- Test with various API responses
- Add console logging during development to verify data

**Rollback:** Remove `.sort()` block - predictions return to original order

### Compatibility Verification

- [x] No breaking changes to existing APIs (client-side only)
- [x] Database changes (if any) are additive only (no database changes)
- [x] UI changes follow existing design patterns (no UI changes)
- [x] Performance impact is negligible (sorting is fast)

---

## Validation Checklist

### Scope Validation

- [x] Story can be completed in one development session (2-3 hours)
- [x] Integration approach is straightforward (add sort before render)
- [x] Follows existing patterns exactly (fetch → transform → render)
- [x] No design or architecture work required

### Clarity Check

- [x] Story requirements are unambiguous (clear sorting formula)
- [x] Integration points are clearly specified (loadPredictions function)
- [x] Success criteria are testable (verify sort order visually)
- [x] Rollback approach is simple (remove sort block)

---

## Implementation Notes for Developer

### Step-by-Step Implementation

1. **Open** `frontend/js/app.js`
2. **Find** the `loadPredictions()` function
3. **Locate** the line where predictions are fetched: `const predictions = await api.getPredictions(params);`
4. **Add sorting code** immediately after fetch, before the `forEach` render loop:
   ```javascript
   // Sort predictions by highest team rating (best matchups first)
   predictions.sort((a, b) => {
     const maxRatingA = Math.max(a.home_team_rating || 0, a.away_team_rating || 0);
     const maxRatingB = Math.max(b.home_team_rating || 0, b.away_team_rating || 0);
     return maxRatingB - maxRatingA; // Descending order
   });
   ```
5. **Save** file
6. **Test** locally:
   - Load predictions
   - Verify sorting works
   - Test week filters
   - Test refresh button
   - Check console for errors
7. **Console log** ratings during testing (optional):
   ```javascript
   console.log('Sorted predictions:', predictions.map(p => ({
     matchup: `${p.away_team} @ ${p.home_team}`,
     maxRating: Math.max(p.home_team_rating, p.away_team_rating)
   })));
   ```
8. **Remove debug logs** before committing
9. **Commit** with clear message about adding prediction sorting

**Estimated Time:** 30 minutes for code + 1-2 hours for testing = 2-3 hours total

---

## Example Expected Output

**Before Sorting (API order):**
1. Rutgers @ Michigan State (max rating: 1680)
2. Georgia @ Texas (max rating: 1920)
3. Kansas @ West Virginia (max rating: 1650)
4. Ohio State @ Penn State (max rating: 1900)

**After Sorting (descending by max rating):**
1. Georgia @ Texas (max rating: 1920) ← Best matchup first
2. Ohio State @ Penn State (max rating: 1900)
3. Rutgers @ Michigan State (max rating: 1680)
4. Kansas @ West Virginia (max rating: 1650) ← Lowest matchup last
